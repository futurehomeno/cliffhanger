name: Go

on:
  push:
    tags:
      - 'v*'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  linter:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Configure git for private modules
        run: |
          git config --global url."https://${{ secrets.GH_OAUTH_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2
          working-directory: .
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

  test:
    if: github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Configure git for private modules
      run: |
        export GH_TOKEN="${{ secrets.GH_OAUTH_TOKEN }}"
        git config --global url."https://$GH_TOKEN@github.com/".insteadOf "https://github.com/"

    - name: Create Mosquitto config
      run: |
        mkdir -p .ci
        cat > .ci/mosquitto.conf <<EOF
        listener 1883
        allow_anonymous true
        persistence false
        EOF

    - name: Start Mosquitto
      run: |
        docker run -d --name mosquitto \
          -p 1883:1883 \
          -v "$PWD/.ci/mosquitto.conf:/mosquitto/config/mosquitto.conf" \
          eclipse-mosquitto:2

    - name: Wait for Mosquitto
      run: |
        for i in {1..5}; do
          nc -z 127.0.0.1 1883 && exit 0
          sleep 2
        done
        echo "Mosquitto not ready"
        docker logs mosquitto
        exit 1

    - name: Install mockery (v2, Go 1.25 compatible)
      run: |
        go install github.com/vektra/mockery/v2@latest
        echo "$HOME/go/bin" >> $GITHUB_PATH

    - name: Generate mocks
      run: |
        mockery --version
        make generate-mocks

    - name: Test
      shell: bash
      run: |
        make test

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs:
      - test
      - linter

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Determine previous tag
      id: prevtag
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" --exclude "${GITHUB_REF_NAME}")
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        LAST=${{ steps.prevtag.outputs.last_tag }}
        echo "### Changes since \"$LAST\"" > changes.md
        echo "" >> changes.md

        # Parse commit messages for "(#123)" pattern - works for squash/merge/rebase
        PRS=$(git log "$LAST"..HEAD --pretty=format:"%s" | grep -E "\(#[0-9]+\)")

        if [[ -z "$PRS" ]]; then
          echo "_No PRs found in this release range._" >> changes.md
          exit 0
        fi

        echo "$PRS" >> changes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body_path: changes.md
        files: artifacts/kind-owl-armhf/*.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
